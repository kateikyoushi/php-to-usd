<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <title>Price Canvassing</title>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
          apiKey: "FIREBASE_API_KEY_PLACEHOLDER",
          authDomain: "FIREBASE_AUTH_DOMAIN_PLACEHOLDER",
          projectId: "FIREBASE_PROJECT_ID_PLACEHOLDER",
          storageBucket: "FIREBASE_STORAGE_BUCKET_PLACEHOLDER",
          messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID_PLACEHOLDER",
          appId: "FIREBASE_APP_ID_PLACEHOLDER"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
    </script>
    <link rel="stylesheet" href="styles.css">
</head>
</head>
<body>
    <div class="container">
        <h1>Price Canvassing</h1>
        <p class="subtitle">Track items with live PHP to USD conversion</p>

        <div class="rate-display">
            <span>Exchange Rate</span>
            <span class="rate-value" id="rateDisplay">Loading...</span>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label for="itemName">Item Name</label>
                <input type="text" id="itemName" placeholder="e.g., MacBook Pro 14-inch">
            </div>
            <div class="form-group">
                <label for="itemIcon">Icon</label>
                <input type="text" id="itemIcon" placeholder="e.g., üíª, üì±, üñ•Ô∏è" maxlength="2">
            </div>
            <div class="form-group">
                <label for="itemPrice">Price in PHP (‚Ç±)</label>
                <input type="number" id="itemPrice" placeholder="0.00" step="0.01">
            </div>
            <div class="btn-group">
                <button class="btn-primary" id="addBtn" onclick="saveItem()">Add Item</button>
                <button class="btn-secondary" id="cancelBtn" onclick="cancelEdit()" style="display: none;">Cancel</button>
            </div>
        </div>

        <div id="itemsList" class="items-list"></div>
    </div>

    <script>
        let exchangeRate = 0;
        let editingId = null;

        // Fetch real-time exchange rate
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=PHP&to=USD');
                const data = await response.json();
                exchangeRate = data.rates.USD;
                document.getElementById('rateDisplay').textContent = `1 PHP = $${exchangeRate.toFixed(4)} USD`;
                await renderItems();
            } catch (error) {
                document.getElementById('rateDisplay').textContent = 'Error loading rate';
                console.error('Error fetching rate:', error);
            }
        }

        // Get items from Firestore
        async function getItems() {
            try {
                const querySnapshot = await getDocs(collection(db, 'items'));
                const items = [];
                querySnapshot.forEach((doc) => {
                    items.push({ id: doc.id, ...doc.data() });
                });
                return items;
            } catch (error) {
                console.error('Error getting items:', error);
                return [];
            }
        }

        // Save item to Firestore
        async function saveItemToFirestore(item) {
            try {
                const docRef = await addDoc(collection(db, 'items'), item);
                return docRef.id;
            } catch (error) {
                console.error('Error adding item:', error);
                return null;
            }
        }

        // Update item in Firestore
        async function updateItemInFirestore(id, item) {
            try {
                await updateDoc(doc(db, 'items', id), item);
            } catch (error) {
                console.error('Error updating item:', error);
            }
        }

        // Delete item from Firestore
        async function deleteItemFromFirestore(id) {
            try {
                await deleteDoc(doc(db, 'items', id));
            } catch (error) {
                console.error('Error deleting item:', error);
            }
        }

        // Convert PHP to USD
        function convertToUSD(phpAmount) {
            return (phpAmount * exchangeRate).toFixed(2);
        }

        // Add or update item
        async function saveItem() {
            const name = document.getElementById('itemName').value.trim();
            const icon = document.getElementById('itemIcon').value.trim() || 'üì¶';
            const price = parseFloat(document.getElementById('itemPrice').value);

            if (!name || !price || price <= 0) {
                alert('Please enter valid item name and price');
                return;
            }

            if (editingId !== null) {
                // Update existing item
                await updateItemInFirestore(editingId, { name, icon, price });
                editingId = null;
                document.getElementById('addBtn').textContent = 'Add Item';
                document.getElementById('cancelBtn').style.display = 'none';
            } else {
                // Add new item
                const newItem = {
                    name,
                    icon,
                    price
                };
                const id = await saveItemToFirestore(newItem);
                if (id) {
                    // Optionally, you can store the id if needed
                }
            }

            clearForm();
            await renderItems();
        }

        // Edit item
        async function editItem(id, event) {
            event.preventDefault();
            event.stopPropagation();
            
            const items = await getItems();
            const item = items.find(item => item.id === id);

            if (item) {
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemIcon').value = item.icon || 'üì¶';
                document.getElementById('itemPrice').value = item.price;
                editingId = id;
                document.getElementById('addBtn').textContent = 'Update Item';
                document.getElementById('cancelBtn').style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Delete item
        async function deleteItem(id, event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (confirm('Delete this item?')) {
                await deleteItemFromFirestore(id);
                await renderItems();
            }
        }

        // Cancel editing
        function cancelEdit() {
            editingId = null;
            clearForm();
            document.getElementById('addBtn').textContent = 'Add Item';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        // Clear form
        function clearForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemIcon').value = '';
            document.getElementById('itemPrice').value = '';
        }

        // Render items
        async function renderItems() {
            const items = await getItems();
            const container = document.getElementById('itemsList');

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No items yet. Add your first item above.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map(item => `
                <a href="item.html?id=${item.id}" class="item-card">
                    <div class="item-info">
                        <div class="item-name">${item.icon || 'üì¶'} ${item.name}</div>
                        <div class="item-prices">
                            <span class="price-php">‚Ç±${item.price.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            <span class="price-usd">‚âà $${convertToUSD(item.price)} USD</span>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-icon btn-edit" onclick="editItem('${item.id}', event)" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-icon btn-delete" onclick="deleteItem('${item.id}', event)" title="Delete">üóëÔ∏è</button>
                        <span class="chevron">‚Ä∫</span>
                    </div>
                </a>
            `).join('');
        }

        // Allow Enter key to add item
        document.getElementById('itemPrice').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveItem();
            }
        });

        // Initialize
        (async () => {
            await fetchExchangeRate();
        })();
        
        // Refresh rate every 5 minutes
        setInterval(fetchExchangeRate, 300000);
    </script>
</body>
</html>
